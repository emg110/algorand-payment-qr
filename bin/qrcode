#!/usr/bin/env node
var yargs = require('yargs')
var qr = require('../lib')
const Utils = require('./renderer/utils')

function save (file, options) {
  const {address, xnote, note, label, amount, asset} = options;
  const alrorandURI = `algorand://${address}?label=${label}&amount=${amount}${asset ? '&asset='+asset : ''}${xnote ? '&xnote='+note : '&note='+note}`

  qr.toFile(file, alrorandURI, options, function (err, data) {
    if (err) {
      console.error('Error:', err.message)
      process.exit(1)
    }

    console.log('saved qrcode to: ' + file + '\n')
  })
}

function print (options) {
  options.type = 'terminal'
  qr.toString(alrorandURI, options, function (err) {
    if (err) {
      console.error('Error:', err.message)
      process.exit(1)
    }
  })
}

function parseOptions (args) {
  return {
    xnote: args.xnote,
    amount: args.amount,
    label: args.label,
    asset: args.asset,
    note: args.note,
    version: args.qversion,
    errorCorrectionLevel: args.error,
    type: args.type,
    small: !!args.small,
    inverse: !!args.inverse,
    maskPattern: args.mask,
    margin: args.qzone,
    width: args.width,
    scale: args.scale,
    color: {
      light: args.lightcolor,
      dark: args.darkcolor
    }
  }
}

function processInputs (opts) {
  if (!opts) {
    yargs.showHelp()
    process.exit(1)
  }

  if (opts.output) {
    save(opts.output, parseOptions(opts))
  } else {
    print(parseOptions(opts))
  }
}

var argv = yargs
  .detectLocale(false)
  .usage('Usage: $0 [options]')
  .option('x', {
    alias: 'xnote',
    description: 'Algorand URI xnote field',
    group: 'Algorand URI params:',
    type: 'string'
  })
  .option('d', {
    alias: 'dest',
    description: 'Algorand URI destination wallet (account) address field',
    group: 'Algorand URI params:',
    type: 'number'
  })
  .option('a', {
    alias: 'amount',
    description: 'Algorand URI amount field',
    group: 'Algorand URI params:',
    type: 'number'
  })
  .option('l', {
    alias: 'label',
    description: 'Algorand URI label field',
    group: 'Algorand URI params:',
    type: 'string'
  })
  .option('s', {
    alias: 'asset',
    description: 'Algorand URI asset id field',
    group: 'Algorand URI params:',
    type: 'string'
  })
  .option('n', {
    alias: 'note',
    description: 'Algorand URI note field',
    group: 'Algorand URI params:',
    type: 'string'
  })
  .option('v', {
    alias: 'qversion',
    description: 'QR Code symbol version (1 - 40)',
    group: 'QR Code options:',
    type: 'number'
  })
  .option('e', {
    alias: 'error',
    description: 'Error correction level',
    choices: ['L', 'M', 'Q', 'H'],
    group: 'QR Code options:'
  })
  .option('m', {
    alias: 'mask',
    description: 'Mask pattern (0 - 7)',
    group: 'QR Code options:',
    type: 'number'
  })
  .option('t', {
    alias: 'type',
    description: 'Output type',
    choices: ['png', 'svg', 'utf8'],
    implies: 'output',
    group: 'Renderer options:'
  })
  .option('i', {
    alias: 'inverse',
    type: 'boolean',
    description: 'Invert colors',
    group: 'Renderer options:'
  })
  .option('w', {
    alias: 'width',
    description: 'Image width (px)',
    conflicts: 'scale',
    group: 'Renderer options:',
    type: 'number'
  })
  .option('r', {
    alias: 'ratio',
    description: 'Scale ratio factor',
    conflicts: 'width',
    group: 'Renderer options:',
    type: 'number'
  })
  .option('q', {
    alias: 'qzone',
    description: 'Quiet zone size',
    group: 'Renderer options:',
    type: 'number'
  })
  .option('b', {
    alias: 'background',
    description: 'background RGBA hex color',
    group: 'Renderer options:'
  })
  .option('f', {
    alias: 'foreground',
    description: 'Foreground RGBA hex color',
    group: 'Renderer options:'
  })
  .option('p', {
    alias: 'puny',
    type: 'boolean',
    description: 'Output smaller QR code to terminal',
    conflicts: 'type',
    group: 'Renderer options:'
  })
  .option('o', {
    alias: 'output',
    description: 'Output file'
  })
  .help('h')
  .alias('h', 'help')
  .version()
  .example('$0 -p 1000000 -b "Payment for coffee" -a 45 -n "This is a test transaction for QR code generator"', 'Draw in terminal window')
  .example('$0 -o out.png -p 1000000 -b "Payment for coffee" -a 45 -n "This is a test transaction for QR code generator"', 'Save as png image')
  .example('$0 -d F00 -o out.png -p 1000000 -b "Payment for coffee" -a 45 -n "This is a test transaction for QR code generator"', 'Use red as foreground color')
  .parserConfiguration({'parse-numbers': false})
  .argv

processInputs(argv)

